<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Weather layer</title>
  <style>
  html, body, #map-canvas {
    height: 100%;

    background-color: white;

   
  }

  #Button {
      background: green;
      display:block;
      height:80px;
      width:232px;
      text-indent:-9999px;
      padding-bottom: 20px;
  }
  #Button:hover{
  width: 232px;
  height: 80px;
  background-position: -232px 0;
  }
  #Button:active {
  width: 232px;
  height: 80px;
  background-position: -464px 0;
  }

  </style>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=weather"></script>
  <script src="js/jquery.js"></script>
  <script src="chart/Chart.js"></script>
  <script src='nprogress.js'></script>
  <link rel='stylesheet' href='nprogress.css'/>
  <script src="http://gmaps-utility-library.googlecode.com/svn/trunk/markermanager/release/src/markermanager.js"></script>


  <script>
  //globals
  var frameDelay = 1000;
  var count = 0;
  var simcount = 0;
  var hour = 0;
  var date = null;
  var start = false;
  var stations = [];
  var weatherRecords = [];
  var netdata = [];
  var tripdata = [];
  var simdata = null;
  var map = null;
  var circles = [];
  var ctx = null;
  var datestring = "Today";
  var netnode = [];
  var tripnode = [];
  var routedump = [];
  var simulating = false;

  function getxmllist(path){
    xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET", path + "xmllist.xml", false);
    xmlhttp.send();
    xmllist = xmlhttp.responseXML;
    return xmllist.getElementsByTagName("name");
  }

  function getsimulationdata(){
    xmlhttp = new XMLHttpRequest();
    console.log("getting simulation data");
    xmlhttp.open("GET", "simulation/data.xml", false);
    xmlhttp.send();
    xmllist = xmlhttp.responseXML;
    simdata = xmllist.getElementsByTagName("date");
    console.log("got sim data");
    NProgress.done();

  }

  function extractJourneyData(){
    
    var namelist = getxmllist("journeydata/");
    //document.getElementById("loadbar").max = 39;
    for(x=0; x<namelist.length; x++){
      var filename = namelist[x].childNodes[0].nodeValue;
      var fullname = "journeydata/".concat(filename);
      xmlhttp = new XMLHttpRequest();
      xmlhttp.open("GET", fullname, false);
      console.log(fullname);
      xmlhttp.send();
      xmldata = xmlhttp.responseXML;
      netdata[x] = xmldata.getElementsByTagName("date");
      NProgress.inc();
      //console.log(netdata[x].item(0).attributes[0].value);
      //document.getElementById("loadbar").progress = x/39;
    }

    
    
  }

  function extractTripData(){
    var namelist = getxmllist("tripdata/");
    for(x=0; x<namelist.length; x++){
      var filename = namelist[x].childNodes[0].nodeValue;
      var fullname = "tripdata/".concat(filename);
      xmlhttp = new XMLHttpRequest();
      xmlhttp.open("GET", fullname, false);
      console.log(fullname);
      xmlhttp.send();
      xmldata = xmlhttp.responseXML;
      console.log(xmldata)
      tripdata[x] = xmldata.getElementsByTagName("date");
    }
  }

  function getNetDataNode(attr, type){
    var node = null;
    if(type == "date"){
      for(x=0; x<netdata.length; x++){
        for(y=0; y<netdata[x].length; y++){
          if(netdata[x].item(y).attributes[0].value == attr)
            node = netdata[x][y];
        }
      }
    }

    return node;
  }

  function getTripDataNode(date){
    var node = null;
    for(x=0; x<tripdata.length; x++){
      for(y=0; y<tripdata[x].length; y++){
        if(tripdata[x].item(y).attributes[0].value == date)
          node = tripdata[x][y];
      }
    }
    return node;
  }

  function getDayLabels(){
    var list = [];
    if(count > 12){
      for(i=(count-12); i<=count+12; i++){
        list = list.concat(netnode[i].attributes[0].value);
      }
    }
    else{
      for(i=(count+24); i>=count; i--){
        list = list.concat(netnode[i].attributes[0].value);
      }
    }
    return list;
    
  }

  function getsimgraph(station){
    var list = [];
    var data = [];
    if(simcount > 12){
      for(i=(simcount-12); i<=simcount+12; i++){
        list = list.concat(simdata[i].attributes[0].value);
        var datalist = simdata[i].getElementsByTagName('record');
        for(x=0; x<datalist.length; x++){
          if(datalist[x].attributes[1].value == "station"){
            var id = parseInt(datalist[x].getElementsByTagName('id')[0].childNodes[0].nodeValue);
            if(id == station){
              var bikes = parseInt(datalist[x].getElementsByTagName('bikes')[0].childNodes[0].nodeValue);
              if(bikes == null){
                bikes = 0;
              }
              data = data.concat(bikes);
            }
          }
          if(x == datalist.length-1){
            if(data.length < list.length){
              data = data.concat(0);
            }
          }
        }
      }
    }
    else{
      for(i=(simcount+24); i>=simcount; i--){
        list = list.concat(simdata[i].attributes[0].value);
        var datalist = simdata[i].getElementsByTagName('record');
        for(x=0; x<datalist.length; x++){
          if(datalist[x].attributes[1].value == "station"){
            var id = parseInt(datalist[x].getElementsByTagName('id')[0].childNodes[0].nodeValue);
            if(id == station){
              var bikes = parseInt(datalist[x].getElementsByTagName('bikes')[0].childNodes[0].nodeValue);
              if(bikes == null){
                bikes = 0;
              }
              data = data.concat(bikes);
            }
          }
          if(x == datalist.length-1){
            if(data.length < list.length){
              data = data.concat(0);
            }
          }
        }
      }
    }
    console.log(list);
    console.log(data);
    return [list, data];
  }



  function getGraphData(station){
    var list = [];
    if(count > 12){
      for(i=(count-12); i<=count+12; i++){
        var stationlist = netnode[i].getElementsByTagName('stationId');
        for(x=0; x<stationlist.length; x++){
          var id = parseInt(stationlist[x].attributes[0].value);
          if(id == station){
            list = list.concat(parseInt(stationlist[x].getElementsByTagName("net")[0].firstChild.data));
          }
        }
      }
    }
    else{
      for(i=(count+24); i>=count; i--){
        var stationlist = netnode[i].getElementsByTagName('stationId');
        for(x=0; x<stationlist.length; x++){
          var id = parseInt(stationlist[x].attributes[0].value);
          if(id == station){
            list = list.concat(parseInt(stationlist[x].getElementsByTagName("net")[0].firstChild.data));
          }
        }
      }
    }
    return list;
  }


  function createCircle(latLng,nbBikes,name,map,i){

  var stationOptions = {
    strokeColor: '#FF0000',
    strokeOpacity: 0,
    strokeWeight: 1,
    fillColor: '#FF0000',
    fillOpacity: 0.5,
    map: map,
    center: latLng,
    radius: nbBikes*5
  };

  var html = "<div class='infowindow'><b>" + name + "</b> <br/>" + "Number of Bikes: " + nbBikes +'<br/></div>';

  var infowindow = new google.maps.InfoWindow({content: html});

  circles[i] = new google.maps.Circle(stationOptions);

  google.maps.event.addListener(circles[i],"click",function(){
    if(!simulating){
      document.getElementById('charttitle').innerHTML = name + "<br/>" + datestring;
      document.getElementById('cdiv').style.zIndex = "10";
      var range = getDayLabels();
      var gdata = getGraphData(i);
      var dataset = {
        labels: range,
        datasets: [
          {
            label: "Testicles",
            fillColor: "rgba(255,0,0,0.2)",
            strokeColor: "rgba(220,220,220,1)",
            pointColor: "rgba(220,220,220,1)",
            pointStrokeColor: "#fff",
            pointHighlightFill: "#fff",
            pointHighlightStroke: "rgba(220,220,220,1)",
            data: gdata
          },
          {
            label: "Penis",
            fillColor: "rgba(0,0,255,0.2)",
            strokeColor: "rgba(220,220,220,1)",
            pointColor: "rgba(220,220,220,0)",
            pointStrokeColor: "rgba(220,220,220,0)",
            pointHighlightFill: "rgba(220,220,220,0)",
            pointHighlightStroke: "rgba(220,220,220,0)",
            data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
          }


        ]
      };

      var linechart = new Chart(ctx).Line(dataset, {
        scaleGridLineColor: "rgba(255,255,255,0.5)"
      });
    }else if(simulating){
      document.getElementById('charttitle').innerHTML = name + "<br/>" + document.getElementById('date').innerHTML;
      document.getElementById('cdiv').style.zIndex = "10";
      var simgraph = getsimgraph(i);
      var range = simgraph[0];
      var gdata = simgraph[1];
      var dataset = {
        labels: range,
        datasets: [
          {
            label: "Testicles",
            fillColor: "rgba(255,0,0,0.2)",
            strokeColor: "rgba(220,220,220,1)",
            pointColor: "rgba(220,220,220,1)",
            pointStrokeColor: "#fff",
            pointHighlightFill: "#fff",
            pointHighlightStroke: "rgba(220,220,220,1)",
            data: gdata
          }


        ]
      };

      var linechart = new Chart(ctx).Line(dataset, {
        scaleGridLineColor: "rgba(255,255,255,0.5)"
      });
    }
    });
  
  }


  function drawNetCircles(node){

    var stationlist = node.getElementsByTagName("stationId");
    for(i=0; i<stationlist.length; i++){
          var radius = parseInt(stationlist[i].getElementsByTagName("net")[0].firstChild.data);
          var index = parseInt(stationlist[i].attributes[0].value);
          index -= 1;
          radius = (radius*5);
          try{
            circles[index].setRadius(radius);
            if(radius < 0){
              circles[index].setOptions({fillColor : "#0033FF"});
            }
            if(radius > 0){
              circles[index].setOptions({fillColor : "#FF0000"});
            }
          }catch(err){
            //ignore
          }
          
        }
      
      /*var latLng = new google.maps.LatLng(stationNode.getElementsByTagName("lat")[0].firstChild.data,stationNode.getElementsByTagName("long")[0].firstChild.data);
      var name = stationNode.getElementsByTagName("name")[0].firstChild.data;*/
      
      //var radius = parseInt(stationlist[i].childNodes[1].nodeValue, 10);
      //createCircle(latLng, radius, name, map);

    
  }

  function updateWeather(){
    //loop through the length of the list of weather records
    if(count < weatherRecords.length){
      date = weatherRecords[count].getElementsByTagName("bst")[0].childNodes[0].nodeValue;
      var d = new Date(date);
      datestring = d.toDateString();

      //for each iteration, change the words displayed bottom of screen to that of the record
      document.getElementById("date").innerHTML = datestring;
      document.getElementById("temp").innerHTML = weatherRecords[count].getElementsByTagName("temp")[0].childNodes[0].nodeValue + " degrees celcius";
      //sometimes event tag may be nil where weather is clear abit of hardcoding is required
      if(weatherRecords[count].getElementsByTagName("events").length != 0)
        document.getElementById("weather").innerHTML = weatherRecords[count].getElementsByTagName("events")[0].childNodes[0].nodeValue;
      else document.getElementById("weather").innerHTML = "Clear";
      document.getElementById('wind').innerHTML = weatherRecords[count].getElementsByTagName("wind")[0].childNodes[0].nodeValue + " knots";
      
      drawNetCircles(netnode[count]);
      //console.log(netnode);
      //move the slider
      document.getElementById('slider').value = count;
      //increment counter
      count++;
      //if start boolean is true, meaning that user has pressed play, 
      //set the timeout before the next update, the timeout being the speed at which the user desires
      if(start)
        setTimeout(updateWeather, frameDelay);
    }

  }

  function updatesim(){
    var gotweather = 0;
    if(simcount < simdata.length){
      records = simdata[simcount].getElementsByTagName('record');
      document.getElementById('date').innerHTML = simdata[simcount].attributes[0].value;
      if(records[0].attributes[1].value == "weather"){
        gotweather = 1;
        document.getElementById('temp').innerHTML = records[0].getElementsByTagName('mean_tempc')[0].childNodes[0].nodeValue + "d.Celcius";
        document.getElementById('wind').innerHTML = "";
        try{
          document.getElementById('weather').innerHTML = records[0].getElementsByTagName('events')[0].childNodes[0].nodeValue;
        }catch(err){
          //console.log(err);
        }
      }
      for(i=gotweather; i<records.length; i++){
        var id = parseInt(records[i].getElementsByTagName('id')[0].childNodes[0].nodeValue);
        var radius = parseInt(records[i].getElementsByTagName('bikes')[0].childNodes[0].nodeValue);
        try{
          circles[id].setRadius(radius*5);
        }catch(err){
          //console.log(err);
        }
      }
      document.getElementById('slider').value = simcount;
      simcount++;

      if(start){
        setTimeout(updatesim, frameDelay);
      }
    }
  }

  function updateHourly(tpnode, hourlist){
    if(hour<24){
      console.log(hour);
      document.getElementById('date').innerHTML = hourlist[hour].attributes[0].value;
      for(i=0; i<circles.length; i++){
          circles[i].setRadius(0);
      }
      for(x=0; x<routedump.length; x++){
        routedump[x].setMap(null);
      }
      triplist = hourlist[hour].getElementsByTagName('trip');
      for(i=0; i<triplist.length; i++){
        endpoint = circles[parseInt(triplist[i].attributes[0].value)];
        stpoint = circles[parseInt(triplist[i].attributes[1].value)];
        try{
        endpoint.setRadius(25); stpoint.setRadius(50);
        routedump = routedump.concat(drawLines(stpoint, endpoint));
        }catch(err){
          console.log(err);
        }
      }
      hour++;

      if(start){
        setTimeout(function(){
          updateHourly(tpnode, hourlist);
        }, frameDelay + 2000);
      }
    }
  }

  function drawLines(start, end){
    var arrow = {
      path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
    };

    var coordinates = [
      start.getCenter(),
      end.getCenter()
      ];
    var route = new google.maps.Polyline({
      path: coordinates,
      geodesic: true,
      strokeColor: '#000000',
      strokeOpacity: 0.6,
      strokeWeight: 1,
      icons: [{
        icon: arrow,
        offset: '100%'
      }]
    });

    route.setMap(map);
    return route;
  }


  function initialize() {

    NProgress.start();
    xmlUrl = "http://www.tfl.gov.uk/tfl/syndication/feeds/cycle-hire/livecyclehireupdates.xml";
 
    var request = new XMLHttpRequest();
    request.open('GET', xmlUrl, true);
    request.onload = function() {
      loadData(request.responseXML);
    };
    request.send();

    xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET", "weather_history2013_14.xml", false);
    xmlhttp.send();
    xmlWeather = xmlhttp.responseXML;
    weatherRecords = xmlWeather.getElementsByTagName("record");
    
    //what happens when user presses play
    document.getElementById('play').onclick = function(){   
      document.getElementById('slider').max = weatherRecords.length;
      document.getElementById('slider').value = count;
      simulating = false;
      if(!start){ 
        for(x=0; x<routedump.length; x++){
        routedump[x].setMap(null);
        }
        for(i=0; i<circles.length; i++){
          circles[i].setRadius(0);
        } 
        start = true;
        document.getElementById('cdiv').style.zIndex = "-10";
        //start playing through weather histry
        updateWeather();
        //change button to pause button
        document.getElementById('play').innerHTML = "Pause";
        document.getElementById('hourly').disabled = true;
        document.getElementById('simulation').disabled = true;
      }
      //if already playing
      else if(start){
        //change state to not playing
        start = false;
        //change button to play button
        document.getElementById('play').innerHTML = "Daily";
        document.getElementById('hourly').disabled = false;
        document.getElementById('simulation').disabled = false;
      }
    }

    document.getElementById('hourly').onclick = function(){
      if(!start){
        start = true;
        hour = 0;
        document.getElementById('cdiv').style.zIndex = "-10";
        var tpnode = getTripDataNode(date);
        var hourlist = tpnode.getElementsByTagName('time');
        updateHourly(tpnode, hourlist);
        document.getElementById('hourly').innerHTML = "Pause";
        document.getElementById('play').disabled = true;
        document.getElementById('simulation').disabled = true;
      }else if(start){
        start = false;
        document.getElementById('hourly').innerHTML = "Hourly";
        document.getElementById('play').disabled = false;
        document.getElementById('simulation').disabled = false;
      }
    }

    document.getElementById('simulation').onclick = function(){
      
      simulating = true;
      if(!start){
        for(x=0; x<routedump.length; x++){
        routedump[x].setMap(null);
        } 
        for(i=0; i<circles.length; i++){
          circles[i].setRadius(0);
          circles[i].setOptions({fillColor : "#000000"});
        }
        start = true;
        document.getElementById('simulation').innerHTML = "Stop";
        document.getElementById('play').disabled = true;
        document.getElementById('hourly').disabled = true;
        document.getElementById('slider').max = simdata.length;
        document.getElementById('slider').value = simcount;
        updatesim();
      }else if(start){
        start = false;
        
        document.getElementById('simulation').innerHTML = "Simulation";
        document.getElementById('play').disabled = false;
        document.getElementById('hourly').disabled = true;
      }
    }

    //what happens when user selects the speed at which he wants the histry to play by
    document.getElementById('speed').onchange = function(){
      //get the value
      var speedx = document.getElementById('speed').options[document.getElementById('speed').selectedIndex].value;
      //set the frameDelay
      frameDelay = 1000/speedx;
    }

    //initialize the slider
    document.getElementById('slider').value = 0;
    document.getElementById('slider').max = weatherRecords.length;
    //allow control of playback by moving slider
    document.getElementById('slider').onchange = function(){
      if(!simulating)
        count = document.getElementById('slider').value;
      if(simulating)
        simcount = document.getElementById('slider').value;
      if(!start){
        if(!simulating)
          updateWeather();
        if(simulating)
          updatesim();
      }
    }

   

    Chart.defaults.global.scaleLineColor = "rgba(255,255,255, 0.5)";
    ctx = document.getElementById('chart').getContext("2d");

    
    

  }


  function loadData(data)
  {
  

    var mapOptions = {
      zoom: 12,
      center: new google.maps.LatLng(51.518175,-0.128721)
    };
    
    map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

    /*var weatherLayer = new google.maps.weather.WeatherLayer({
      temperatureUnits: google.maps.weather.TemperatureUnit.CELCIUS
    });
    weatherLayer.setMap(map);

    var cloudLayer = new google.maps.weather.CloudLayer();
    cloudLayer.setMap(map);*/

    stations = data.getElementsByTagName("station");
    //console.log(stations);

    for(i=0;i<stations.length;i++){
      var latLng = new google.maps.LatLng(stations[i].getElementsByTagName("lat")[0].firstChild.data,stations[i].getElementsByTagName("long")[0].firstChild.data);
      var nbBikes = stations[i].getElementsByTagName("nbBikes")[0].firstChild.data;
      var name = stations[i].getElementsByTagName("name")[0].firstChild.data;    
      createCircle(latLng,nbBikes,name,map,i);
      //console.log(stations[i].getElementsByTagName("id")[0].firstChild.data);
    }
    extractJourneyData();
    document.getElementById('loader').innerHTML = "Loading trip data";
    extractTripData();
    document.getElementById('loader').innerHTML = "Getting Sim Data";
    getsimulationdata();

    for(i=0; i < weatherRecords.length; i++){
      date = weatherRecords[i].getElementsByTagName("bst")[0].childNodes[0].nodeValue;
      netnode[i] = getNetDataNode(date, "date"); 
    }


    document.getElementById("loader").style.zIndex="-1";
  }

  google.maps.event.addDomListener(window, 'load', initialize);

  


  </script>
</head>
<body>
  <div id="pediogyOverall" style="width: 100%; height: 100%;background:black;" >
    <div id="pediogyToolbar" style="float: left; display: inline-block; width: 25%; height: 100%; background: black;">
        <p id = "date" style = "text-align:center; color:white; float:left; width:100%; ">Today.</p>
        <p id = "temp" style = "text-align:center; color:white; float:left; width:100%; ">16 degrees celcius</p>
        <p id = "wind" style = "text-align:center; color:white; float:left; width:100%; ">60knots</p>
        <p id = "weather" style = "text-align:center; color:white; float:left; width:100%; ">Sunny</p>  
    </div>
    <div id="pediogyViewer" style="float: left;display: inline-block; width: 75%; height: 100%; background: white;">
      <div id="blab" style="width: 100%; height: 80%; background: white; text-align: center;">
          <div id="loader" style = "width:75%; position: absolute; top: 200px; margin-left: auto; margin-right: auto;z-index:10; color:white; font-size: 30px; background-color:rgba(0,0,0,0.7);">Loading</br>Red = excess bikes</br>Blue = lack of bikes</br>Black = simulation</br>Black-arrows = bike movement</div>
          <div id="map-canvas"></div>
      </div>
      <div id="phpDebug" style="width: 100%; height: 20%; background: white;  margin-left: auto; margin-right: auto; float: left">
        <input id = "slider" type = "range" style = "position:relative; width:100%;"></input>
        <div id="buttonSpace" style="width: 100%; text-align: center; margin-bottom:20px;">
          <button type = "button" id = "play"  >Daily</button>
          <button type = "button" id = "hourly"  >Hourly</button>
          <button type = "button" id = "simulation" >Simulation</button>
          <form action = "" id = "playspeed" style = "padding-top:10px;">
            <select id = "speed" style = "border-radius:10px; font-size:30px;">
              <option value= "1.0" selected>1.0x</option>
              <option value= "1.5">1.5x</option>
              <option value= "2.0">2.0x</option>
              <option value= "4.0">4.0x</option>
            </select>
          </form>
        </div>
        
      </div>
    </div>
  </div>

  <div id="cdiv" style = "width:20%; position: absolute; top: 350px; left: 20px; z-index:-10; background-color:rgba(0,0,0,0.95); border-radius:5px;">
    <p id = "charttitle" style = "color:white;">Graph</p>
    <canvas id="chart" width="300" height="200" padding="10px"></canvas>
  </div>
  <p id = "footer" style = "text-align:center; color:white; ">Weather Simulation tools</p>


</body>
</html>