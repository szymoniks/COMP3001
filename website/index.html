<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Weather layer</title>
  <style>
  html, body, #map-canvas {
    height: 95%;
    margin: 2px;
    padding: 2px;
    background-color: black;

   
  }

  #map-canvas {
    border-radius: 15px;
    border-style: outset;
  }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=weather"></script>
  <script src="js/jquery.js"></script>
  <script src="chart/Chart.js"></script>
  <script src='nprogress.js'></script>
  <link rel='stylesheet' href='nprogress.css'/>
  <script src="http://gmaps-utility-library.googlecode.com/svn/trunk/markermanager/release/src/markermanager.js"></script>


  <script>
  //globals
  var frameDelay = 1000;
  var count = 0;
  var hour = 0;
  var date = null;
  var start = false;
  var stations = [];
  var weatherRecords = [];
  var netdata = [];
  var tripdata = [];
  var map = null;
  var circles = [];
  var ctx = null;
  var datestring = "Today";
  var netnode = [];
  var tripnode = [];
  var routedump = [];

  function getxmllist(path){
    xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET", path + "xmllist.xml", false);
    xmlhttp.send();
    xmllist = xmlhttp.responseXML;
    return xmllist.getElementsByTagName("name");
  }

  function extractJourneyData(){
    
    var namelist = getxmllist("journeydata/");
    //document.getElementById("loadbar").max = 39;
    for(x=0; x<namelist.length; x++){
      var filename = namelist[x].childNodes[0].nodeValue;
      var fullname = "journeydata/".concat(filename);
      xmlhttp = new XMLHttpRequest();
      xmlhttp.open("GET", fullname, false);
      console.log(fullname);
      xmlhttp.send();
      xmldata = xmlhttp.responseXML;
      netdata[x] = xmldata.getElementsByTagName("date");
      NProgress.inc();
      //console.log(netdata[x].item(0).attributes[0].value);
      //document.getElementById("loadbar").progress = x/39;
    }

    NProgress.done();  
    
  }

  function extractTripData(){
    var namelist = getxmllist("tripdata/");
    for(x=0; x<namelist.length; x++){
      var filename = namelist[x].childNodes[0].nodeValue;
      var fullname = "tripdata/".concat(filename);
      xmlhttp = new XMLHttpRequest();
      xmlhttp.open("GET", fullname, false);
      console.log(fullname);
      xmlhttp.send();
      xmldata = xmlhttp.responseXML;
      tripdata[x] = xmldata.getElementsByTagName("date");
    }
  }

  function getNetDataNode(attr, type){
    var node = null;
    if(type == "date"){
      for(x=0; x<netdata.length; x++){
        for(y=0; y<netdata[x].length; y++){
          if(netdata[x].item(y).attributes[0].value == attr)
            node = netdata[x][y];
        }
      }
    }

    return node;
  }

  function getTripDataNode(date){
    var node = null;
    for(x=0; x<tripdata.length; x++){
      for(y=0; y<tripdata[x].length; y++){
        if(tripdata[x].item(y).attributes[0].value == date)
          node = tripdata[x][y];
      }
    }
    return node;
  }

  function getDayLabels(){
    var list = [];
    if(count > 7){
      for(i=(count-7); i<=count; i++){
        list = list.concat(netnode[i].attributes[0].value);
      }
    }
    else{
      for(i=(count+7); i>=count; i--){
        list = list.concat(netnode[i].attributes[0].value);
      }
    }
    return list;
    
  }

  function getGraphData(station){
    var list = [];
    if(count > 7){
      for(i=(count-7); i<=count; i++){
        var stationlist = netnode[i].getElementsByTagName('stationId');
        for(x=0; x<stationlist.length; x++){
          var id = parseInt(stationlist[x].attributes[0].value);
          if(id == station){
            list = list.concat(parseInt(stationlist[x].getElementsByTagName("net")[0].firstChild.data));
          }
        }
      }
    }
    else{
      for(i=(count+7); i>=count; i--){
        var stationlist = netnode[i].getElementsByTagName('stationId');
        for(x=0; x<stationlist.length; x++){
          var id = parseInt(stationlist[x].attributes[0].value);
          if(id == station){
            list = list.concat(parseInt(stationlist[x].getElementsByTagName("net")[0].firstChild.data));
          }
        }
      }
    }
    return list;
  }


  function createCircle(latLng,nbBikes,name,map,i){

  var stationOptions = {
    strokeColor: '#FF0000',
    strokeOpacity: 0,
    strokeWeight: 1,
    fillColor: '#FF0000',
    fillOpacity: 0.5,
    map: map,
    center: latLng,
    radius: nbBikes*5
  };

  var html = "<div class='infowindow'><b>" + name + "</b> <br/>" + "Number of Bikes: " + nbBikes +'<br/></div>';

  var infowindow = new google.maps.InfoWindow({content: html});

  circles[i] = new google.maps.Circle(stationOptions);

  google.maps.event.addListener(circles[i],"click",function(){
    document.getElementById('charttitle').innerHTML = name + "<br/>" + datestring;
    document.getElementById('cdiv').style.zIndex = "10";
    var range = getDayLabels();
    var gdata = getGraphData(i);
    var dataset = {
      labels: range,
      datasets: [
        {
          label: "Testicles",
          fillColor: "rgba(255,0,0,0.2)",
          strokeColor: "rgba(220,220,220,1)",
          pointColor: "rgba(220,220,220,1)",
          pointStrokeColor: "#fff",
          pointHighlightFill: "#fff",
          pointHighlightStroke: "rgba(220,220,220,1)",
          data: gdata
        },
        {
          label: "Penis",
          fillColor: "rgba(0,0,255,0.2)",
          strokeColor: "rgba(220,220,220,1)",
          pointColor: "rgba(220,220,220,0)",
          pointStrokeColor: "rgba(220,220,220,0)",
          pointHighlightFill: "rgba(220,220,220,0)",
          pointHighlightStroke: "rgba(220,220,220,0)",
          data: [0,0,0,0,0,0,0,0,0]
        }


      ]
    };

    var linechart = new Chart(ctx).Line(dataset, {
      scaleGridLineColor: "rgba(255,255,255,0.5)"
    });
  });
  }


  function drawNetCircles(node){

    var stationlist = node.getElementsByTagName("stationId");
    for(i=0; i<stationlist.length; i++){
          var radius = parseInt(stationlist[i].getElementsByTagName("net")[0].firstChild.data);
          var index = parseInt(stationlist[i].attributes[0].value);
          index -= 1;
          radius = (radius*5);
          try{
            circles[index].setRadius(radius);
            if(radius < 0){
              circles[index].setOptions({fillColor : "#0033FF"});
            }
            if(radius > 0){
              circles[index].setOptions({fillColor : "#FF0000"});
            }
          }catch(err){
            //ignore
          }
          
        }
      
      /*var latLng = new google.maps.LatLng(stationNode.getElementsByTagName("lat")[0].firstChild.data,stationNode.getElementsByTagName("long")[0].firstChild.data);
      var name = stationNode.getElementsByTagName("name")[0].firstChild.data;*/
      
      //var radius = parseInt(stationlist[i].childNodes[1].nodeValue, 10);
      //createCircle(latLng, radius, name, map);

    
  }

  function updateWeather(){
    //loop through the length of the list of weather records
    if(count < weatherRecords.length){
      date = weatherRecords[count].getElementsByTagName("bst")[0].childNodes[0].nodeValue;
      var d = new Date(date);
      datestring = d.toDateString();

      //for each iteration, change the words displayed bottom of screen to that of the record
      document.getElementById("date").innerHTML = datestring;
      document.getElementById("temp").innerHTML = weatherRecords[count].getElementsByTagName("temp")[0].childNodes[0].nodeValue + " degrees celcius";
      //sometimes event tag may be nil where weather is clear abit of hardcoding is required
      if(weatherRecords[count].getElementsByTagName("events").length != 0)
        document.getElementById("weather").innerHTML = weatherRecords[count].getElementsByTagName("events")[0].childNodes[0].nodeValue;
      else document.getElementById("weather").innerHTML = "Clear";
      document.getElementById('wind').innerHTML = weatherRecords[count].getElementsByTagName("wind")[0].childNodes[0].nodeValue + " knots";
      
      drawNetCircles(netnode[count]);
      //console.log(netnode);
      //move the slider
      document.getElementById('slider').value = count;
      //increment counter
      count++;
      //if start boolean is true, meaning that user has pressed play, 
      //set the timeout before the next update, the timeout being the speed at which the user desires
      if(start)
        setTimeout(updateWeather, frameDelay);
    }

  }

  function updateHourly(tpnode, hourlist){
    if(hour<24){
      console.log(hour);
      document.getElementById('date').innerHTML = hourlist[hour].attributes[0].value;
      for(i=0; i<circles.length; i++){
          circles[i].setRadius(0);
      }
      for(x=0; x<routedump.length; x++){
        routedump[x].setMap(null);
      }
      triplist = hourlist[hour].getElementsByTagName('trip');
      for(i=0; i<triplist.length; i++){
        endpoint = circles[parseInt(triplist[i].attributes[0].value)];
        stpoint = circles[parseInt(triplist[i].attributes[1].value)];
        try{
        endpoint.setRadius(25); stpoint.setRadius(50);
        routedump = routedump.concat(drawLines(stpoint, endpoint));
        }catch(err){
          console.log(err);
        }
      }
      hour++;

      if(start){
        setTimeout(function(){
          updateHourly(tpnode, hourlist);
        }, frameDelay + 2000);
      }
    }
  }

  function drawLines(start, end){
    var arrow = {
      path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW
    };

    var coordinates = [
      start.getCenter(),
      end.getCenter()
      ];
    var route = new google.maps.Polyline({
      path: coordinates,
      geodesic: true,
      strokeColor: '#000000',
      strokeOpacity: 0.6,
      strokeWeight: 1,
      icons: [{
        icon: arrow,
        offset: '100%'
      }]
    });

    route.setMap(map);
    return route;
  }


  function initialize() {

    NProgress.start();
    xmlUrl = "http://www.tfl.gov.uk/tfl/syndication/feeds/cycle-hire/livecyclehireupdates.xml";
 
    var request = new XMLHttpRequest();
    request.open('GET', xmlUrl, true);
    request.onload = function() {
      loadData(request.responseXML);
    };
    request.send();

    xmlhttp = new XMLHttpRequest();
    xmlhttp.open("GET", "weather_history2013_14.xml", false);
    xmlhttp.send();
    xmlWeather = xmlhttp.responseXML;
    weatherRecords = xmlWeather.getElementsByTagName("record");
    
    //what happens when user presses play
    document.getElementById('play').onclick = function(){   
      if(!start){ 
        for(x=0; x<routedump.length; x++){
        routedump[x].setMap(null);
        } 
        start = true;
        document.getElementById('cdiv').style.zIndex = "-10";
        //start playing through weather histry
        updateWeather();
        //change button to pause button
        document.getElementById('play').innerHTML = "Pause";
        document.getElementById('hourly').disabled = true;
        document.getElementById('simulation').disabled = true;
      }
      //if already playing
      else if(start){
        //change state to not playing
        start = false;
        //change button to play button
        document.getElementById('play').innerHTML = "Daily";
        document.getElementById('hourly').disabled = false;
        document.getElementById('simulation').disabled = false;
      }
    }

    document.getElementById('hourly').onclick = function(){
      if(!start){
        start = true;
        hour = 0;
        document.getElementById('cdiv').style.zIndex = "-10";
        var tpnode = getTripDataNode(date);
        var hourlist = tpnode.getElementsByTagName('time');
        updateHourly(tpnode, hourlist);
        document.getElementById('hourly').innerHTML = "Pause";
        document.getElementById('play').disabled = true;
        document.getElementById('simulation').disabled = true;
      }else if(start){
        start = false;
        document.getElementById('hourly').innerHTML = "Hourly";
        document.getElementById('play').disabled = false;
        document.getElementById('simulation').disabled = false;
      }
    }

    //what happens when user selects the speed at which he wants the histry to play by
    document.getElementById('speed').onchange = function(){
      //get the value
      var speedx = document.getElementById('speed').options[document.getElementById('speed').selectedIndex].value;
      //set the frameDelay
      frameDelay = 1000/speedx;
    }

    //initialize the slider
    document.getElementById('slider').value = 0;
    document.getElementById('slider').max = weatherRecords.length;
    //allow control of playback by moving slider
    document.getElementById('slider').onchange = function(){
      count = document.getElementById('slider').value
      if(!start)
        updateWeather();
    }

   

    Chart.defaults.global.scaleLineColor = "rgba(255,255,255, 0.5)";
    ctx = document.getElementById('chart').getContext("2d");

    
    

  }


  function loadData(data)
  {
  

    var mapOptions = {
      zoom: 12,
      center: new google.maps.LatLng(51.518175,-0.128721)
    };
    
    map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

    /*var weatherLayer = new google.maps.weather.WeatherLayer({
      temperatureUnits: google.maps.weather.TemperatureUnit.CELCIUS
    });
    weatherLayer.setMap(map);

    var cloudLayer = new google.maps.weather.CloudLayer();
    cloudLayer.setMap(map);*/

    stations = data.getElementsByTagName("station");
    //console.log(stations);

    for(i=0;i<stations.length;i++){
      var latLng = new google.maps.LatLng(stations[i].getElementsByTagName("lat")[0].firstChild.data,stations[i].getElementsByTagName("long")[0].firstChild.data);
      var nbBikes = stations[i].getElementsByTagName("nbBikes")[0].firstChild.data;
      var name = stations[i].getElementsByTagName("name")[0].firstChild.data;    
      createCircle(latLng,nbBikes,name,map,i);
      console.log(stations[i].getElementsByTagName("id")[0].firstChild.data);
    }
    extractJourneyData();
    document.getElementById('loader').innerHTML = "Loading trip data";
    extractTripData();

    for(i=0; i < weatherRecords.length; i++){
      date = weatherRecords[i].getElementsByTagName("bst")[0].childNodes[0].nodeValue;
      netnode[i] = getNetDataNode(date, "date"); 
    }


    document.getElementById("loader").style.zIndex="-1";
  }

  google.maps.event.addDomListener(window, 'load', initialize);

  


  </script>
</head>
<body>
  <div id="map-canvas"></div>
  <input id = "slider" type = "range" style = "position:relative; width:100%;"></input>
  <button type = "button" id = "play" style = "position:absolute; left:34%; border-radius:10px; font-size:30px; float:left; width:200px;" >Daily</button>
  <button type = "button" id = "hourly" style = "position:absolute; left:54%; border-radius:10px; font-size:30px; float:left; width:200px;" >Hourly</button>
  <button type = "button" id = "simulation" style = "position:absolute; left:67%; border-radius:10px; font-size:30px; float:left; width:200px;" >Simulation</button>
  <form action = "" id = "playspeed" style = "position:absolute; left:48%; border-radius:10px; font-size:30px;">
    <select id = "speed" style = "border-radius:10px; font-size:30px;">
      <option value= "1.0" selected>1.0x</option>
      <option value= "1.5">1.5x</option>
      <option value= "2.0">2.0x</option>
      <option value= "4.0">4.0x</option>
    </select>
  </form>
  <p id = "date" style = "text-align:center; color:white; float:left; padding-left: 100px; ">Today.</p>
  <p id = "temp" style = "text-align:center; color:white; float:left; padding-left: 10px; ">16 degrees celcius</p>
  <p id = "wind" style = "text-align:center; color:white; float:left; padding-left: 10px; ">60knots</p>
  <p id = "weather" style = "text-align:center; color:white; float:left; padding-left: 10px; ">Sunny</p>

  <div id="loader" style = "width: 100%; height: 100%; position: absolute; top: 200px; left: 120px; z-index:10; color:white; font-size: 30px;">Loading</div>

  <div id="cdiv" style = "position: absolute; top: 350px; left: 80px; z-index:-10; background-color:rgba(0,0,0,0.95); border-radius:5px;">
    <p id = "charttitle" style = "color:white;">Graph</p>
    <canvas id="chart" width="400" height="200" padding="10px"></canvas>
  </div>

</body>
</html>